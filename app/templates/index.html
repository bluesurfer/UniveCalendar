{% extends 'base.html' %}
{% set active_page='home' %}


{% block styles %}

    <!-- Full Calendar style -->
    <link href="http://cdnjs.cloudflare.com/ajax/libs/fullcalendar/2.4.0/fullcalendar.min.css" rel="stylesheet">
    <link href="http://cdnjs.cloudflare.com/ajax/libs/fullcalendar/2.4.0/fullcalendar.print.css" rel='stylesheet' media='print'>

    {{ super() }}

    <link href="{{ url_for('static', filename='css/plugins/qtip/jquery.qtip.css') }}" rel='stylesheet'>

{% endblock %}

{% block heading %}
    <div class="row  border-bottom white-bg dashboard-header">
        <div class="col-lg-6">
            <h2>{{ gettext('Welcome %(username)s', username=current_user.username) }}</h2>
            {% if g.unread %}
                <small>{{ ngettext('You have %(num)s unread feed.', 'You have %(num)s unread feeds.', g.unread) }}</small>
            {% endif %}
        </div>
        <div class="col-lg-6">
            <div class="row text-left">
                <div class="col-xs-4">
                    <div class=" m-l-md">
                        <span class="h4 font-bold m-t block">{{ current_user.courses.count() }}</span>
                        <small class="text-muted m-b block">{{ ngettext('%(num)s Followed Course', '%(num)s Followed Courses', current_user.courses.count()) }}</small>
                    </div>
                </div>
                <div class="col-xs-4">
                    <span class="h4 font-bold m-t block">{{ current_user.total_credits() }}</span>
                    <small class="text-muted m-b block">{{ gettext('Total credits') }}</small>
                </div>
                <div class="col-xs-4">
                    <span class="h4 font-bold m-t block">{{ current_user.number_of_lessons() }}</span>
                    <small class="text-muted m-b block">{{ gettext('Lessons to attend') }}</small>
                </div>

            </div>
        </div>
    </div>
{% endblock %}


{% block content %}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="row">
                <div class="col-lg-12">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    {% endwith %}

    <div class="row animated fadeInDown">
        <div class="col-lg-4">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>{{ gettext('Latest feeds') }}</h5>
                </div>
                <div class="ibox-content">
                    <div class="feed-activity-list">
                        {% if not feeds %}
                            <p class="text-center">{{ gettext('No feed found') }}</p>
                        {% else %}
                            {% for feed in feeds %}
                                <div class="feed-element">
                                    <a href="#" class="pull-left">
                                        <img alt="image" class="img-circle" src="{{ feed.gravatar }}">
                                    </a>

                                    <div class="media-body ">
                                        <small class="pull-right">{{ moment(feed.timestamp).fromNow() }}</small>
                                        <strong>{{ feed.author }}</strong><br> {{ feed.title }}<br>

                                        <div class="well">
                                            {{ feed.body }}
                                        </div>
                                        <small class="text-muted">{{ gettext('Published %(fromnow)s at %(date)s', fromnow=moment(feed.timestamp).fromNow(), date=moment(feed.timestamp).format('HH:MM - D.M.YYYY')) }}</small>
                                    </div>
                                </div>
                            {% endfor %}
                            <div class="text-center link-block m-t">
                                <a href="{{ url_for('main.show_feeds') }}">
                                    <i class="fa fa-envelope"></i> <strong>{{ gettext('Read all feeds') }}</strong>
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>{{ gettext('My calendar') }} </h5>
                </div>
                <div class="ibox-content">
                    {% if not current_user.courses.first() %}
                        <div class="alert alert-warning">
                            {{ gettext('You calendar is empty.') }} <a class="alert-link" href="{{ url_for('main.courses') }}">{{ gettext('Add courses') }}</a>.
                        </div>
                    {% endif %}
                    <div id="calendar"></div>
                    <div class="row">
                        <div class="col-lg-12">
                            <a href="{{ url_for('main.download_calendar') }}" class="btn btn-success btn-block m-t"><i class="fa fa-download"></i> {{ gettext('Download Calendar') }}</a>
                            <small>{{ gettext('Get your personal calendar in ICS format, compatible with the most common Calendar apps') }}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}

    {{ super() }}

    <!-- Full Calendar -->
    <script src="http://cdnjs.cloudflare.com/ajax/libs/fullcalendar/2.4.0/fullcalendar.min.js"></script>
    {% if g.locale == 'it' %}
        <script src="{{ url_for('static', filename='js/plugins/fullcalendar/lang/it.js') }}"></script>
    {% endif %}

    <!-- Qtip2 -->
    <script src="http://cdnjs.cloudflare.com/ajax/libs/qtip2/2.2.1/basic/jquery.qtip.min.js"></script>

    <script>
        $(document).ready(function () {

            /* initialize the calendar
             -----------------------------------------------------------------*/
            var date = new Date();
            var d = date.getDate();
            var m = date.getMonth();
            var y = date.getFullYear();

            $('#calendar').fullCalendar({
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'month,agendaWeek,agendaDay'
                },
                events: function (start, end, timezone, callback) {
                    $.ajax({
                        url: $SCRIPT_ROOT + '/api/users/{{ current_user.id }}/lessons/',
                        dataType: 'json',
                        success: function (data) {
                            callback(data.lessons);
                        }
                    })
                },
                eventRender: function (event, element, view) {
                    element.qtip({
                        content: {
                            title: event.title,
                            text: '<p> Dalle ' + moment(event.start).format('HH:mm') + ' alle ' + moment(event.end).format('HH:mm') + '</p>' +
                            '<p> ' + event.location + '</p>'
                        },
                        position: {
                            my: 'center left',
                            at: 'center right'
                        },
                        show: 'mouseover',
                        style: 'light qtip-bootstrap'
                    });
                },
                editable: false,
                droppable: false
            });

        });

    </script>
{% endblock %}